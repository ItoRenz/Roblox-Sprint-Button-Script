local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")

local isSprinting = false
local normalSpeed = 16 -- Kecepatan normal
local sprintSpeed = normalSpeed * 2 -- Kecepatan lari (2x lipat)
local sprintEffects = {} -- Untuk menyimpan light stick di tangan
local currentColor = Color3.fromRGB(255, 0, 0) -- Warna saat ini

-- Deteksi Platform (Mobile atau PC)
local isMobile = UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled
local isPC = not isMobile

-- Buat GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "SprintGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- ==================== TOGGLE BUTTON PC ====================
local toggleButtonPC
if isPC then
    toggleButtonPC = Instance.new("TextButton")
    toggleButtonPC.Name = "SprintTogglePC"
    toggleButtonPC.Size = UDim2.new(0, 30, 0, 30)
    toggleButtonPC.Position = UDim2.new(1, -40, 0.5, -90)
    toggleButtonPC.BackgroundColor3 = Color3.fromRGB(100, 200, 255)
    toggleButtonPC.TextColor3 = Color3.fromRGB(255, 255, 255)
    toggleButtonPC.TextSize = 16
    toggleButtonPC.Text = "▶"
    toggleButtonPC.Font = Enum.Font.GothamBold
    toggleButtonPC.BorderSizePixel = 0
    toggleButtonPC.Visible = true
    toggleButtonPC.Parent = screenGui

    -- Shadow effect PC
    local shadowPC = Instance.new("TextButton")
    shadowPC.Name = "Shadow"
    shadowPC.Size = UDim2.new(1, 4, 1, 4)
    shadowPC.Position = UDim2.new(0, 2, 0, 2)
    shadowPC.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    shadowPC.TextTransparency = 1
    shadowPC.BorderSizePixel = 0
    shadowPC.ZIndex = 0
    shadowPC.Parent = toggleButtonPC

    local shadowCornerPC = Instance.new("UICorner")
    shadowCornerPC.CornerRadius = UDim.new(0, 15)
    shadowCornerPC.Parent = shadowPC

    -- UICorner untuk button PC
    local cornerPC = Instance.new("UICorner")
    cornerPC.CornerRadius = UDim.new(0, 15)
    cornerPC.Parent = toggleButtonPC

    -- UIStroke untuk border PC
    local strokePC = Instance.new("UIStroke")
    strokePC.Color = Color3.fromRGB(200, 230, 255)
    strokePC.Thickness = 3
    strokePC.Parent = toggleButtonPC

    -- Status Label PC
    local statusLabelPC = Instance.new("TextLabel")
    statusLabelPC.Name = "StatusLabelPC"
    statusLabelPC.Size = UDim2.new(0, 70, 0, 18)
    statusLabelPC.Position = UDim2.new(1, -62, 0.5, -60)
    statusLabelPC.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    statusLabelPC.BackgroundTransparency = 0.3
    statusLabelPC.TextColor3 = Color3.fromRGB(100, 200, 255)
    statusLabelPC.TextSize = 12
    statusLabelPC.Font = Enum.Font.GothamBold
    statusLabelPC.Text = "WALK"
    statusLabelPC.BorderSizePixel = 0
    statusLabelPC.Parent = screenGui

    local statusCornerPC = Instance.new("UICorner")
    statusCornerPC.CornerRadius = UDim.new(0, 8)
    statusCornerPC.Parent = statusLabelPC

    -- Fungsi update UI PC
    local function updateButtonUIPC()
        if isSprinting then
            toggleButtonPC.BackgroundColor3 = Color3.fromRGB(255, 100, 150)
            strokePC.Color = Color3.fromRGB(255, 200, 200)
            toggleButtonPC.Text = "⏸"
            statusLabelPC.Text = "RUNNING"
            statusLabelPC.TextColor3 = Color3.fromRGB(255, 100, 150)
        else
            toggleButtonPC.BackgroundColor3 = Color3.fromRGB(100, 200, 255)
            strokePC.Color = Color3.fromRGB(200, 230, 255)
            toggleButtonPC.Text = "▶"
            statusLabelPC.Text = "WALK"
            statusLabelPC.TextColor3 = Color3.fromRGB(100, 200, 255)
        end
    end

    -- Button click untuk toggle PC
    toggleButtonPC.MouseButton1Click:Connect(function()
        isSprinting = not isSprinting
        setSprinting(isSprinting)
        
        -- Animasi rotasi saat diklik
        local rotationTween = game:GetService("TweenService"):Create(
            toggleButtonPC,
            TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out),
            {Rotation = toggleButtonPC.Rotation + 360}
        )
        rotationTween:Play()
    end)

    -- Hover effect untuk button PC
    toggleButtonPC.MouseEnter:Connect(function()
        local strokeTween = game:GetService("TweenService"):Create(
            strokePC,
            TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {Thickness = 5}
        )
        strokeTween:Play()
    end)

    toggleButtonPC.MouseLeave:Connect(function()
        local strokeTween = game:GetService("TweenService"):Create(
            strokePC,
            TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {Thickness = 3}
        )
        strokeTween:Play()
    end)

    -- Store reference untuk update UI
    _G.updateButtonUIPC = updateButtonUIPC
end

-- ==================== TOGGLE BUTTON MOBILE ====================
local toggleButtonMobile
if isMobile then
    toggleButtonMobile = Instance.new("TextButton")
    toggleButtonMobile.Name = "SprintToggleMobile"
    toggleButtonMobile.Size = UDim2.new(0, 28, 0, 28)
    toggleButtonMobile.Position = UDim2.new(1, -38, 0.5, -70)
    toggleButtonMobile.BackgroundColor3 = Color3.fromRGB(100, 200, 255)
    toggleButtonMobile.TextColor3 = Color3.fromRGB(255, 255, 255)
    toggleButtonMobile.TextSize = 16
    toggleButtonMobile.Text = "▶"
    toggleButtonMobile.Font = Enum.Font.GothamBold
    toggleButtonMobile.BorderSizePixel = 0
    toggleButtonMobile.Visible = true
    toggleButtonMobile.Parent = screenGui

    -- Shadow effect Mobile
    local shadowMobile = Instance.new("TextButton")
    shadowMobile.Name = "Shadow"
    shadowMobile.Size = UDim2.new(1, 4, 1, 4)
    shadowMobile.Position = UDim2.new(0, 2, 0, 2)
    shadowMobile.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    shadowMobile.TextTransparency = 1
    shadowMobile.BorderSizePixel = 0
    shadowMobile.ZIndex = 0
    shadowMobile.Parent = toggleButtonMobile

    local shadowCornerMobile = Instance.new("UICorner")
    shadowCornerMobile.CornerRadius = UDim.new(0, 15)
    shadowCornerMobile.Parent = shadowMobile

    -- UICorner untuk button Mobile
    local cornerMobile = Instance.new("UICorner")
    cornerMobile.CornerRadius = UDim.new(0, 15)
    cornerMobile.Parent = toggleButtonMobile

    -- UIStroke untuk border Mobile
    local strokeMobile = Instance.new("UIStroke")
    strokeMobile.Color = Color3.fromRGB(200, 230, 255)
    strokeMobile.Thickness = 3
    strokeMobile.Parent = toggleButtonMobile

    -- Status Label Mobile
    local statusLabelMobile = Instance.new("TextLabel")
    statusLabelMobile.Name = "StatusLabelMobile"
    statusLabelMobile.Size = UDim2.new(0, 60, 0, 18)
    statusLabelMobile.Position = UDim2.new(1, -57, 0.5, -40)
    statusLabelMobile.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    statusLabelMobile.BackgroundTransparency = 0.3
    statusLabelMobile.TextColor3 = Color3.fromRGB(100, 200, 255)
    statusLabelMobile.TextSize = 11
    statusLabelMobile.Font = Enum.Font.GothamBold
    statusLabelMobile.Text = "WALK"
    statusLabelMobile.BorderSizePixel = 0
    statusLabelMobile.Parent = screenGui

    local statusCornerMobile = Instance.new("UICorner")
    statusCornerMobile.CornerRadius = UDim.new(0, 8)
    statusCornerMobile.Parent = statusLabelMobile

    -- Fungsi update UI Mobile
    local function updateButtonUIMobile()
        if isSprinting then
            toggleButtonMobile.BackgroundColor3 = Color3.fromRGB(255, 100, 150)
            strokeMobile.Color = Color3.fromRGB(255, 200, 200)
            toggleButtonMobile.Text = "⏸"
            statusLabelMobile.Text = "RUNNING"
            statusLabelMobile.TextColor3 = Color3.fromRGB(255, 100, 150)
        else
            toggleButtonMobile.BackgroundColor3 = Color3.fromRGB(100, 200, 255)
            strokeMobile.Color = Color3.fromRGB(200, 230, 255)
            toggleButtonMobile.Text = "▶"
            statusLabelMobile.Text = "WALK"
            statusLabelMobile.TextColor3 = Color3.fromRGB(100, 200, 255)
        end
    end

    -- Button click untuk toggle Mobile
    toggleButtonMobile.MouseButton1Click:Connect(function()
        isSprinting = not isSprinting
        setSprinting(isSprinting)
        
        -- Animasi scale saat diklik
        local scaleTween = game:GetService("TweenService"):Create(
            toggleButtonMobile,
            TweenInfo.new(0.2, Enum.EasingStyle.Back, Enum.EasingDirection.Out),
            {Size = UDim2.new(0, 32, 0, 32)}
        )
        scaleTween:Play()
        scaleTween.Completed:Connect(function()
            local scaleBackTween = game:GetService("TweenService"):Create(
                toggleButtonMobile,
                TweenInfo.new(0.1, Enum.EasingStyle.Back, Enum.EasingDirection.In),
                {Size = UDim2.new(0, 28, 0, 28)}
            )
            scaleBackTween:Play()
        end)
    end)

    -- Hover effect untuk button Mobile
    toggleButtonMobile.MouseEnter:Connect(function()
        local strokeTween = game:GetService("TweenService"):Create(
            strokeMobile,
            TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {Thickness = 5}
        )
        strokeTween:Play()
    end)

    toggleButtonMobile.MouseLeave:Connect(function()
        local strokeTween = game:GetService("TweenService"):Create(
            strokeMobile,
            TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {Thickness = 3}
        )
        strokeTween:Play()
    end)

    -- Store reference untuk update UI
    _G.updateButtonUIMobile = updateButtonUIMobile
end

-- ==================== CORE FUNCTIONS ====================

-- Fungsi untuk membuat light stick dengan trail effect
local function createHandLightSticks()
    -- Hapus efek lama
    for _, effect in pairs(sprintEffects) do
        if effect and effect.Parent then
            effect:Destroy()
        end
    end
    sprintEffects = {}
    
    -- Cari tangan kanan dan kiri
    local rightHand = character:FindFirstChild("RightHand")
    local leftHand = character:FindFirstChild("LeftHand")
    
    local hands = {}
    if rightHand then table.insert(hands, rightHand) end
    if leftHand then table.insert(hands, leftHand) end
    
    -- Jika tidak ada, coba cari dari humanoid
    if #hands == 0 then
        for _, part in pairs(character:GetChildren()) do
            if part.Name == "RightHand" or part.Name == "LeftHand" or 
               part.Name == "RightLowerArm" or part.Name == "LeftLowerArm" then
                table.insert(hands, part)
            end
        end
    end
    
    -- Buat light stick untuk setiap tangan
    for _, hand in pairs(hands) do
        local lightStick = Instance.new("Part")
        lightStick.Name = "LightStick"
        lightStick.Shape = Enum.PartType.Cylinder
        lightStick.Material = Enum.Material.Neon
        lightStick.Size = Vector3.new(1.5, 0.2, 0.2)
        lightStick.CanCollide = false
        lightStick.CFrame = hand.CFrame * CFrame.Angles(0, math.rad(90), 0)
        lightStick.TopSurface = Enum.SurfaceType.Smooth
        lightStick.BottomSurface = Enum.SurfaceType.Smooth
        lightStick.Parent = hand
        
        -- Warna awal merah
        lightStick.Color = Color3.fromRGB(255, 0, 0)
        lightStick.Transparency = 0.1
        
        -- Weld ke tangan
        local weld = Instance.new("WeldConstraint")
        weld.Part0 = hand
        weld.Part1 = lightStick
        weld.Parent = lightStick
        
        -- PointLight untuk efek cahaya tambahan (DISABLED)
        -- local light = Instance.new("PointLight")
        -- light.Brightness = 2
        -- light.Range = 10
        -- light.Color = Color3.fromRGB(255, 0, 0)
        -- light.Parent = lightStick
        local light = nil
        
        -- Buat Attachment untuk Trail
        local attachment0 = Instance.new("Attachment")
        attachment0.Parent = lightStick
        attachment0.Position = Vector3.new(-0.75, 0, 0)
        
        local attachment1 = Instance.new("Attachment")
        attachment1.Parent = lightStick
        attachment1.Position = Vector3.new(0.75, 0, 0)
        
        -- Buat Trail effect (cahaya memanjang)
        local trail = Instance.new("Trail")
        trail.Attachment0 = attachment0
        trail.Attachment1 = attachment1
        trail.Lifetime = 0.5 -- Durasi jejak cahaya
        trail.MinLength = 0
        trail.MaxLength = 0
        trail.Color = ColorSequence.new(Color3.fromRGB(255, 0, 0))
        trail.Transparency = NumberSequence.new({
            NumberSequenceKeypoint.new(0, 0),
            NumberSequenceKeypoint.new(0.5, 0.3),
            NumberSequenceKeypoint.new(1, 1)
        })
        trail.Parent = lightStick
        
        table.insert(sprintEffects, {stick = lightStick, light = light, trail = trail, 
                                     attachment0 = attachment0, attachment1 = attachment1})
    end
end

-- Fungsi untuk menghapus light stick
local function removeHandLightSticks()
    for _, effect in pairs(sprintEffects) do
        if effect.stick and effect.stick.Parent then
            effect.stick:Destroy()
        end
    end
    sprintEffects = {}
end

-- Fungsi Sprint
function setSprinting(value)
    isSprinting = value
    
    if isSprinting then
        humanoid.WalkSpeed = sprintSpeed
        createHandLightSticks()
    else
        humanoid.WalkSpeed = normalSpeed
        removeHandLightSticks()
    end
    
    -- Update UI sesuai platform
    if isPC and _G.updateButtonUIPC then
        _G.updateButtonUIPC()
    elseif isMobile and _G.updateButtonUIMobile then
        _G.updateButtonUIMobile()
    end
end

-- ==================== INPUT HANDLING ====================

-- Keyboard input removed - only toggle button controls

-- ==================== EFFECTS ====================

-- Update warna light stick saat sprint
RunService.Heartbeat:Connect(function()
    if isSprinting then
        -- Update warna dengan rainbow effect
        local time = tick() * 3
        local colorIndex = time % 12
        
        local r, g, b
        
        if colorIndex < 1 then
            r = 255; g = 0; b = 0 -- Merah Cerah
        elseif colorIndex < 2 then
            r = 255; g = 165; b = 0 -- Orange
        elseif colorIndex < 3 then
            r = 255; g = 255; b = 0 -- Kuning Cerah
        elseif colorIndex < 4 then
            r = 50; g = 255; b = 0 -- Lime Green
        elseif colorIndex < 5 then
            r = 0; g = 255; b = 100 -- Hijau Cerah
        elseif colorIndex < 6 then
            r = 0; g = 255; b = 255 -- Cyan
        elseif colorIndex < 7 then
            r = 0; g = 100; b = 255 -- Biru Cerah
        elseif colorIndex < 8 then
            r = 50; g = 50; b = 255 -- Biru Dongker
        elseif colorIndex < 9 then
            r = 200; g = 0; b = 255 -- Ungu
        elseif colorIndex < 10 then
            r = 255; g = 0; b = 255 -- Magenta
        elseif colorIndex < 11 then
            r = 255; g = 100; b = 200 -- Pink Cerah
        else
            r = 255; g = 255; b = 255 -- Putih Cemerlang
        end
        
        currentColor = Color3.fromRGB(r, g, b)
        
        -- Apply warna ke semua light stick dan trail
        for i, effect in pairs(sprintEffects) do
            if effect.stick and effect.stick.Parent then
                effect.stick.Color = currentColor
                
                -- Update trail color
                if effect.trail then
                    effect.trail.Color = ColorSequence.new(currentColor)
                end
                
                -- Efek pulsing pada transparency
                local pulse = math.sin(time * 8) * 0.15 + 0.2
                effect.stick.Transparency = pulse
            end
        end
    end
end)

-- ==================== RESPAWN HANDLING ====================

-- Handle respawn - update character reference
player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    humanoid = character:WaitForChild("Humanoid")
    rootPart = character:WaitForChild("HumanoidRootPart")
    sprintEffects = {}
    
    -- Terapkan sprint state ke character baru
    if isSprinting then
        humanoid.WalkSpeed = sprintSpeed
        createHandLightSticks()
    else
        humanoid.WalkSpeed = normalSpeed
    end
end)
