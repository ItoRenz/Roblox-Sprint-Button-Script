--[[
===========================================================
  SPRINT SYSTEM - SERVER SCRIPT
  Author       : ItoRenz00
  Description  : Handles server-side sprint logic and lightstick effects.
  Features     : Speed management, lightstick creation, R6/R15 support.
===========================================================
--]]

-- ==================== SERVICES ====================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ==================== CONSTANTS ====================
local NORMAL_SPEED = 20
local SPRINT_MULTIPLIER = 2
local SPRINT_SPEED = NORMAL_SPEED * SPRINT_MULTIPLIER

local LIGHTSTICK_CONFIG = {
	Size = Vector3.new(1.2, 0.15, 0.15),
	DefaultColor = Color3.fromRGB(255, 0, 0),
	DefaultTransparency = 0.3,
	TrailLifetime = 1.0
}

-- ==================== REMOTE EVENTS SETUP ====================
local remoteFolder = Instance.new("Folder")
remoteFolder.Name = "SprintRemotes"
remoteFolder.Parent = ReplicatedStorage

local toggleSprintEvent = Instance.new("RemoteEvent")
toggleSprintEvent.Name = "ToggleSprint"
toggleSprintEvent.Parent = remoteFolder

local updateColorEvent = Instance.new("RemoteEvent")
updateColorEvent.Name = "UpdateColor"
updateColorEvent.Parent = remoteFolder

-- ==================== PLAYER DATA ====================
local playerSprintData = {}

-- ==================== LIGHTSTICK FUNCTIONS ====================
local function findHandParts(character)
	local hands = {}
	local humanoid = character:FindFirstChild("Humanoid")
	if not humanoid then return hands end
	local rigType = humanoid.RigType
	if rigType == Enum.HumanoidRigType.R15 then
		local rightHand = character:FindFirstChild("RightHand")
		local leftHand = character:FindFirstChild("LeftHand")
		if rightHand then table.insert(hands, rightHand) end
		if leftHand then table.insert(hands, leftHand) end
	elseif rigType == Enum.HumanoidRigType.R6 then
		local rightArm = character:FindFirstChild("Right Arm")
		local leftArm = character:FindFirstChild("Left Arm")
		if rightArm then table.insert(hands, rightArm) end
		if leftArm then table.insert(hands, leftArm) end
	end
	return hands
end

local function createTrailEffect(lightStick, color)
	local attachment0 = Instance.new("Attachment")
	attachment0.Parent = lightStick
	attachment0.Position = Vector3.new(-0.6, 0, 0)
	local attachment1 = Instance.new("Attachment")
	attachment1.Parent = lightStick
	attachment1.Position = Vector3.new(0.6, 0, 0)
	local trail = Instance.new("Trail")
	trail.Attachment0 = attachment0
	trail.Attachment1 = attachment1
	trail.Lifetime = LIGHTSTICK_CONFIG.TrailLifetime
	trail.MinLength = 0.1
	trail.MaxLength = 0
	trail.Color = ColorSequence.new(color)
	trail.LightEmission = 1
	trail.LightInfluence = 0
	trail.Brightness = 1
	trail.Transparency = NumberSequence.new({
		NumberSequenceKeypoint.new(0, 0),
		NumberSequenceKeypoint.new(0.5, 0.2),
		NumberSequenceKeypoint.new(1, 1)
	})
	trail.Parent = lightStick
	return trail
end

local function createLightStick(hand, color)
	local lightStick = Instance.new("Part")
	lightStick.Name = "LightStick"
	lightStick.Shape = Enum.PartType.Cylinder
	lightStick.Material = Enum.Material.Neon
	lightStick.Size = LIGHTSTICK_CONFIG.Size
	lightStick.CanCollide = false
	lightStick.CFrame = hand.CFrame * CFrame.Angles(0, math.rad(90), 0)
	lightStick.TopSurface = Enum.SurfaceType.Smooth
	lightStick.BottomSurface = Enum.SurfaceType.Smooth
	lightStick.Color = color or LIGHTSTICK_CONFIG.DefaultColor
	lightStick.Transparency = LIGHTSTICK_CONFIG.DefaultTransparency
	lightStick.Parent = hand
	local weld = Instance.new("WeldConstraint")
	weld.Part0 = hand
	weld.Part1 = lightStick
	weld.Parent = lightStick
	createTrailEffect(lightStick, lightStick.Color)
	return lightStick
end

local function createServerLightSticks(character)
	removeServerLightSticks(character)
	local hands = findHandParts(character)
	if #hands == 0 then return end
	for _, hand in pairs(hands) do
		createLightStick(hand, LIGHTSTICK_CONFIG.DefaultColor)
	end
end

function removeServerLightSticks(character)
	for _, descendant in pairs(character:GetDescendants()) do
		if descendant.Name == "LightStick" then
			descendant:Destroy()
		end
	end
end

-- ==================== SPRINT MANAGEMENT ====================
local function setPlayerSprint(player, isSprinting)
	local character = player.Character
	if not character then return end
	local humanoid = character:FindFirstChild("Humanoid")
	if not humanoid then return end
	playerSprintData[player.UserId] = isSprinting
	if isSprinting then
		humanoid.WalkSpeed = SPRINT_SPEED
		createServerLightSticks(character)
	else
		humanoid.WalkSpeed = NORMAL_SPEED
		removeServerLightSticks(character)
	end
end

local function updateLightStickColor(character, newColor)
	for _, descendant in pairs(character:GetDescendants()) do
		if descendant.Name == "LightStick" and descendant:IsA("Part") then
			descendant.Color = newColor
			local trail = descendant:FindFirstChildOfClass("Trail")
			if trail then
				trail.Color = ColorSequence.new(newColor)
			end
		end
	end
end

local logged = false
local function logOnce(msg)
	if not logged then
		print(msg)
		logged = true
	end
end

-- ==================== REMOTE EVENTS ====================
toggleSprintEvent.OnServerEvent:Connect(function(player, isSprintingState)
	setPlayerSprint(player, isSprintingState)
end)

updateColorEvent.OnServerEvent:Connect(function(player, newColor)
	local character = player.Character
	if character then
		updateLightStickColor(character, newColor)
	end
end)

-- ==================== PLAYER EVENTS ====================
Players.PlayerAdded:Connect(function(player)
	player.CharacterAdded:Connect(function(character)
		local humanoid = character:WaitForChild("Humanoid", 10)
		if not humanoid then return end
		humanoid.WalkSpeed = NORMAL_SPEED
		if playerSprintData[player.UserId] then
			humanoid.WalkSpeed = SPRINT_SPEED
			createServerLightSticks(character)
		end
	end)
end)

Players.PlayerRemoving:Connect(function(player)
	playerSprintData[player.UserId] = nil
end)

logOnce("Author: ItoRenz00 | Sprint System Loaded Successfully")
