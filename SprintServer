-- ServerScriptService - SprintServer
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Buat Remote Events
local remoteFolder = Instance.new("Folder")
remoteFolder.Name = "SprintRemotes"
remoteFolder.Parent = ReplicatedStorage

local toggleSprintEvent = Instance.new("RemoteEvent")
toggleSprintEvent.Name = "ToggleSprint"
toggleSprintEvent.Parent = remoteFolder

local updateColorEvent = Instance.new("RemoteEvent")
updateColorEvent.Name = "UpdateColor"
updateColorEvent.Parent = remoteFolder

-- Konfigurasi
local normalSpeed = 20
local sprintSpeed = normalSpeed * 2

-- Data sprint untuk setiap pemain
local playerSprintData = {}

-- Fungsi untuk membuat lightstick di server
local function createServerLightSticks(character)
    -- Hapus lightstick lama jika ada
    for _, child in pairs(character:GetDescendants()) do
        if child.Name == "LightStick" then
            child:Destroy()
        end
    end
    
    local rightHand = character:FindFirstChild("RightHand")
    local leftHand = character:FindFirstChild("LeftHand")
    
    local hands = {}
    if rightHand then table.insert(hands, rightHand) end
    if leftHand then table.insert(hands, leftHand) end
    
    -- Fallback untuk R6
    if #hands == 0 then
        for _, part in pairs(character:GetChildren()) do
            if part.Name == "RightHand" or part.Name == "LeftHand" or 
               part.Name == "RightLowerArm" or part.Name == "LeftLowerArm" then
                table.insert(hands, part)
            end
        end
    end
    
    for _, hand in pairs(hands) do
        local lightStick = Instance.new("Part")
        lightStick.Name = "LightStick"
        lightStick.Shape = Enum.PartType.Cylinder
        lightStick.Material = Enum.Material.Neon
        lightStick.Size = Vector3.new(1.5, 0.2, 0.2)
        lightStick.CanCollide = false
        lightStick.CFrame = hand.CFrame * CFrame.Angles(0, math.rad(90), 0)
        lightStick.TopSurface = Enum.SurfaceType.Smooth
        lightStick.BottomSurface = Enum.SurfaceType.Smooth
        lightStick.Color = Color3.fromRGB(255, 0, 0)
        lightStick.Transparency = 0.1
        lightStick.Parent = hand
        
        local weld = Instance.new("WeldConstraint")
        weld.Part0 = hand
        weld.Part1 = lightStick
        weld.Parent = lightStick
        
        -- Attachment untuk trail
        local attachment0 = Instance.new("Attachment")
        attachment0.Parent = lightStick
        attachment0.Position = Vector3.new(-0.75, 0, 0)
        
        local attachment1 = Instance.new("Attachment")
        attachment1.Parent = lightStick
        attachment1.Position = Vector3.new(0.75, 0, 0)
        
        local trail = Instance.new("Trail")
        trail.Attachment0 = attachment0
        trail.Attachment1 = attachment1
        trail.Lifetime = 2.0
        trail.MinLength = 0
        trail.MaxLength = 0
        trail.Color = ColorSequence.new(Color3.fromRGB(255, 0, 0))
        trail.Transparency = NumberSequence.new({
            NumberSequenceKeypoint.new(0, 0),
            NumberSequenceKeypoint.new(0.3, 0.2),
            NumberSequenceKeypoint.new(0.7, 0.5),
            NumberSequenceKeypoint.new(1, 1)
        })
        trail.Parent = lightStick
    end
end

-- Fungsi untuk menghapus lightstick
local function removeServerLightSticks(character)
    for _, child in pairs(character:GetDescendants()) do
        if child.Name == "LightStick" then
            child:Destroy()
        end
    end
end

-- Handle toggle sprint dari client
toggleSprintEvent.OnServerEvent:Connect(function(player, isSprintingState)
    local character = player.Character
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    -- Update data pemain
    playerSprintData[player.UserId] = isSprintingState
    
    -- Terapkan perubahan speed dan lightstick
    if isSprintingState then
        humanoid.WalkSpeed = sprintSpeed
        createServerLightSticks(character)
    else
        humanoid.WalkSpeed = normalSpeed
        removeServerLightSticks(character)
    end
end)

-- Handle update warna dari client
updateColorEvent.OnServerEvent:Connect(function(player, newColor)
    local character = player.Character
    if not character then return end
    
    -- Update warna semua lightstick milik pemain
    for _, child in pairs(character:GetDescendants()) do
        if child.Name == "LightStick" and child:IsA("Part") then
            child.Color = newColor
            
            -- Update trail color juga
            local trail = child:FindFirstChildOfClass("Trail")
            if trail then
                trail.Color = ColorSequence.new(newColor)
            end
        end
    end
end)

-- Handle player respawn
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function(character)
        local humanoid = character:WaitForChild("Humanoid")
        
        -- Set normal speed saat spawn
        humanoid.WalkSpeed = normalSpeed
        
        -- Terapkan kembali sprint state jika masih sprint sebelum respawn
        task.wait(0.5)
        if playerSprintData[player.UserId] then
            humanoid.WalkSpeed = sprintSpeed
            createServerLightSticks(character)
        end
    end)
end)

-- Cleanup saat player leave
Players.PlayerRemoving:Connect(function(player)
    playerSprintData[player.UserId] = nil
end)
